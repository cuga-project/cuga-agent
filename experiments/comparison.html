<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>CUGA Profiling Comparison</title>
  <style>
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
    h1 { margin-bottom: 4px; }
    .meta { color: #666; margin-bottom: 16px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; font-size: 14px; }
    th { background: #fafafa; position: sticky; top: 0; }
    code { background: #f6f8fa; padding: 2px 4px; border-radius: 4px; }
    .loading { color: #666; font-style: italic; }
    .error { color: #dc2626; }
  </style>
</head>
<body>
  <h1>CUGA Profiling Comparison</h1>
  <div class="meta">Generated at <span id="now"></span></div>
  <div class="grid">
    <div class="card">
      <h3>Summary</h3>
      <div id="summary"></div>
    </div>
    <div class="card">
      <h3>Config Stats</h3>
      <div id="configStats"></div>
    </div>
  </div>
  <div class="card" style="margin-top:16px">
    <h3>Langfuse Metrics (per run)</h3>
    <div id="langfuseList"></div>
  </div>
  <div class="card" style="margin-top:16px">
    <h3>Aggregates</h3>
    <div id="aggregates"></div>
  </div>
  <script>
    let combined = null;

    async function loadData() {
      try {
        // List of JSON files to load
        const jsonFiles = ['balanced_20250929_011236.json', 'fast_20250929_011021.json'];

        // Try to load all JSON files
        const loadPromises = jsonFiles.map(async (file) => {
          try {
            const resp = await fetch(file);
            if (!resp.ok) {
              console.warn(`Failed to load ${file}: ${resp.status}`);
              return null;
            }
            const data = await resp.json();
            // Extract label from filename (everything before first underscore or before timestamp)
            const label = file.split('_')[0];
            return {label, file, data};
          } catch (error) {
            console.warn(`Error loading ${file}:`, error);
            return null;
          }
        });

        const results = await Promise.all(loadPromises);
        const experiments = results.filter(result => result !== null);

        if (experiments.length === 0) {
          throw new Error('No JSON files could be loaded');
        }

        combined = { experiments };

        document.getElementById('now').textContent = new Date().toLocaleString();
        renderAll();
      } catch (error) {
        console.error('Error loading data:', error);
        document.body.innerHTML += '<div class="error">Error loading JSON data: ' + error.message + '</div>';
      }
    }

    function renderAll() {
      if (!combined) return;
      renderSummary();
      renderConfigStats();
      renderLangfuseList();
      renderAggregates();
    }

    function renderSummary() {
      const el = document.getElementById('summary');
      const rows = combined.experiments.map(exp => {
        const s = exp.data.summary;
        return `<div><strong>${exp.label}</strong>: tests ${s.total_tests}, success ${s.successful_tests}/${s.total_tests} (${s.success_rate.toFixed(1)}%)</div>`;
      }).join('');
      el.innerHTML = rows;
    }

    function renderConfigStats() {
      const el = document.getElementById('configStats');
      const parts = combined.experiments.map(exp => {
        const entries = Object.entries(exp.data.config_stats).map(([k,v]) => {
          return `<tr><td><code>${exp.label}</code></td><td>${k}</td><td>${v.total}</td><td>${v.successful}</td><td>${v.failed}</td><td>${v.avg_time.toFixed(2)}s</td><td>${v.success_rate.toFixed(1)}%</td></tr>`;
        }).join('');
        return entries;
      }).join('');
      el.innerHTML = `<table><thead><tr><th>mode</th><th>config</th><th>total</th><th>ok</th><th>fail</th><th>avg_time</th><th>success_rate</th></tr></thead><tbody>${parts}</tbody></table>`;
    }

    function renderLangfuseList() {
      const el = document.getElementById('langfuseList');
      const rows = combined.experiments.map(exp => {
        const runs = exp.data.langfuse_metrics || [];
        const trs = runs.map(r => {
          return `<tr><td><code>${exp.label}</code></td><td>${r.task}</td><td>${r.llm_calls}</td><td>${r.total_tokens}</td><td>$${r.total_cost.toFixed(4)}</td><td>${r.total_generation_time.toFixed(2)}s</td><td>${r.full_execution_time.toFixed(2)}s</td><td><code>${r.trace_id}</code></td></tr>`;
        }).join('');
        return trs;
      }).join('');
      el.innerHTML = `<table><thead><tr><th>mode</th><th>task</th><th>llm_calls</th><th>tokens</th><th>cost</th><th>gen_time</th><th>full_exec</th><th>trace</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    function renderAggregates() {
      const el = document.getElementById('aggregates');
      const rows = combined.experiments.map(exp => {
        const runs = exp.data.langfuse_metrics || [];
        const agg = runs.reduce((a, r) => {
          a.llm_calls += r.llm_calls;
          a.tokens += r.total_tokens;
          a.cost += r.total_cost;
          a.gen_time += r.total_generation_time;
          a.exec_time_sum += r.full_execution_time;
          return a;
        }, {llm_calls:0, tokens:0, cost:0, gen_time:0, exec_time_sum:0});
        const avg_exec = runs.length ? (agg.exec_time_sum / runs.length) : 0;
        return `<tr><td><code>${exp.label}</code></td><td>${runs.length}</td><td>${agg.llm_calls}</td><td>${agg.tokens}</td><td>$${agg.cost.toFixed(4)}</td><td>${agg.gen_time.toFixed(2)}s</td><td>${avg_exec.toFixed(2)}s</td></tr>`;
      }).join('');
      el.innerHTML = `<table><thead><tr><th>mode</th><th>runs</th><th>llm_calls</th><th>tokens</th><th>cost</th><th>total_gen_time</th><th>avg_full_exec</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    loadData();
  </script>
</body>
</html>